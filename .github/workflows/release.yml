name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: false
        type: string

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build Windows x64
    runs-on: windows-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        
      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          cache-on-failure: true
          
      - name: Install dependencies
        run: pnpm install
      
      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Building version: $VERSION"
      
      - name: Build Tauri app
        run: pnpm tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
      
      - name: Smoke test - verify binary starts
        shell: pwsh
        run: |
          Write-Host "Running smoke tests on built binary..."
          
          $exePath = "src-tauri/target/release/Isolate.exe"
          
          if (-not (Test-Path $exePath)) {
            Write-Error "Binary not found at $exePath"
            exit 1
          }
          
          Write-Host "Binary found: $exePath"
          Write-Host "File size: $((Get-Item $exePath).Length / 1MB) MB"
          
          # Test 1: --version flag
          Write-Host "`n=== Test 1: Version check ==="
          $versionOutput = & $exePath --version 2>&1
          $versionExitCode = $LASTEXITCODE
          
          if ($versionExitCode -ne 0) {
            Write-Error "Version check failed with exit code: $versionExitCode"
            Write-Host "Output: $versionOutput"
            exit 1
          }
          Write-Host "Version output: $versionOutput"
          Write-Host "[PASS] Version check"
          
          # Test 2: --smoke-test flag (comprehensive check)
          Write-Host "`n=== Test 2: Smoke test ==="
          $smokeOutput = & $exePath --smoke-test 2>&1
          $smokeExitCode = $LASTEXITCODE
          
          if ($smokeExitCode -ne 0) {
            Write-Error "Smoke test failed with exit code: $smokeExitCode"
            Write-Host "Output: $smokeOutput"
            exit 1
          }
          Write-Host $smokeOutput
          Write-Host "[PASS] Smoke test"
          
          Write-Host "`n‚úÖ All smoke tests passed!"
      
      - name: List build artifacts
        shell: bash
        run: |
          echo "=== NSIS Installers ==="
          ls -la src-tauri/target/release/bundle/nsis/ || echo "No NSIS artifacts"
          echo ""
          echo "=== MSI Installers ==="
          ls -la src-tauri/target/release/bundle/msi/ || echo "No MSI artifacts"
      
      - name: Generate checksums
        id: checksums
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $checksumFile = "checksums.txt"
          
          # Find and hash all installers
          $artifacts = @()
          
          # NSIS
          $nsisPath = "src-tauri/target/release/bundle/nsis"
          if (Test-Path $nsisPath) {
            Get-ChildItem "$nsisPath/*.exe" | ForEach-Object {
              $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash.ToLower()
              "$hash  $($_.Name)" | Add-Content $checksumFile
              $artifacts += $_.FullName
            }
          }
          
          # MSI
          $msiPath = "src-tauri/target/release/bundle/msi"
          if (Test-Path $msiPath) {
            Get-ChildItem "$msiPath/*.msi" | ForEach-Object {
              $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash.ToLower()
              "$hash  $($_.Name)" | Add-Content $checksumFile
              $artifacts += $_.FullName
            }
          }
          
          # Updater signature
          $sigPath = "src-tauri/target/release/bundle/nsis"
          if (Test-Path "$sigPath/*.sig") {
            Get-ChildItem "$sigPath/*.sig" | ForEach-Object {
              $artifacts += $_.FullName
            }
          }
          
          Write-Host "Generated checksums:"
          Get-Content $checksumFile
          
          # Output for next steps
          "checksums_content<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Get-Content $checksumFile | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
      
      - name: Generate release notes
        id: notes
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Get commits since last tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            echo "üìù Changes since $PREV_TAG:"
            COMMITS=$(git log --pretty=format:"- %s (%h)" "$PREV_TAG"..HEAD --no-merges 2>/dev/null | head -30 || echo "")
          else
            echo "üìù Initial release commits:"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -30 2>/dev/null || echo "")
          fi
          
          # Get tag message if exists
          TAG_MESSAGE=$(git tag -l --format='%(contents)' "v$VERSION" 2>/dev/null || echo "")
          
          # Build release notes
          cat > release_notes.md << NOTES_EOF
          ## üõ°Ô∏è Isolate v${VERSION}
          
          –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ–±—Ö–æ–¥ DPI-–±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –¥–ª—è Windows.
          
          NOTES_EOF
          
          # Add tag message if present
          if [ -n "$TAG_MESSAGE" ]; then
            echo "### üìã –û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞" >> release_notes.md
            echo "" >> release_notes.md
            echo "$TAG_MESSAGE" >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          # Add changes
          cat << CHANGES_EOF >> release_notes.md
          ### ‚ú® –ò–∑–º–µ–Ω–µ–Ω–∏—è
          
          ${COMMITS:-"- –ü–µ—Ä–≤—ã–π —Ä–µ–ª–∏–∑"}
          
          ---
          
          ### üì• –°–∫–∞—á–∞—Ç—å
          
          | –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
          |------|----------|
          | \`Isolate_${VERSION}_x64-setup.exe\` | **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è** ‚Äî NSIS —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ |
          | \`Isolate_${VERSION}_x64_en-US.msi\` | MSI –ø–∞–∫–µ—Ç –¥–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è |
          | \`Isolate_${VERSION}_x64_ru-RU.msi\` | MSI –ø–∞–∫–µ—Ç (—Ä—É—Å—Å–∫–∏–π) |
          
          ### üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞
          
          1. –°–∫–∞—á–∞–π—Ç–µ \`Isolate_${VERSION}_x64-setup.exe\`
          2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ (–º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è "–í—Å—ë —Ä–∞–≤–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å" –≤ SmartScreen)
          3. –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
          4. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞
          
          ### üíª –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
          
          - **–û–°:** Windows 10/11 (64-bit)
          - **Runtime:** WebView2 (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
          - **–ü—Ä–∞–≤–∞:** –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (–¥–ª—è WinDivert)
          
          ### ‚ö†Ô∏è –í–∞–∂–Ω–æ
          
          - –ê–Ω—Ç–∏–≤–∏—Ä—É—Å –º–æ–∂–µ—Ç –ª–æ–∂–Ω–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–∞ WinDivert ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –ø–∞–ø–∫—É –≤ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
          - –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º ‚Äî Windows SmartScreen –ø–æ–∫–∞–∂–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
          
          ---
          
          <details>
          <summary>üîê –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å—É–º–º—ã (SHA256)</summary>
          
          \`\`\`
          CHANGES_EOF
          
          # Add checksums
          if [ -f checksums.txt ]; then
            cat checksums.txt >> release_notes.md
          else
            echo "Checksums will be added manually" >> release_notes.md
          fi
          
          cat >> release_notes.md << 'FOOTER_EOF'
          ```
          
          </details>
          FOOTER_EOF
          
          echo "‚úÖ Release notes generated"
          cat release_notes.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Isolate v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: true
          prerelease: false
          fail_on_unmatched_files: false
          files: |
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/nsis/*.sig
            src-tauri/target/release/bundle/msi/*.msi
            checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifact for smoke test
        uses: actions/upload-artifact@v4
        with:
          name: isolate-windows
          path: src-tauri/target/release/bundle/nsis/*.exe
          retention-days: 1
          if-no-files-found: warn
      
      - name: Summary
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "## üéâ Release v$VERSION created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts uploaded:" >> $GITHUB_STEP_SUMMARY
          echo "- NSIS installer (.exe)" >> $GITHUB_STEP_SUMMARY
          echo "- MSI installers (.msi)" >> $GITHUB_STEP_SUMMARY
          echo "- Checksums (checksums.txt)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Smoke Tests:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Version check passed" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Smoke test passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è **Release is in DRAFT mode** ‚Äî review and publish manually." >> $GITHUB_STEP_SUMMARY
  
  # Post-build smoke test on fresh runner
  smoke-test-release:
    name: Smoke Test Release
    needs: build
    uses: ./.github/workflows/smoke-test.yml
    with:
      artifact_name: isolate-windows
      version: ${{ needs.build.outputs.version }}
