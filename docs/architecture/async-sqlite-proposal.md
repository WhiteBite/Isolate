# Async SQLite Migration Proposal

## 1. –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ Storage –º–æ–¥—É–ª—è

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è
```
src-tauri/src/core/storage/
‚îú‚îÄ‚îÄ mod.rs          # Re-exports, —Ç–µ—Å—Ç—ã
‚îú‚îÄ‚îÄ database.rs     # Core Storage struct, settings, cache
‚îú‚îÄ‚îÄ migrations.rs   # SQL schema (13 —Ç–∞–±–ª–∏—Ü, 12 –∏–Ω–¥–µ–∫—Å–æ–≤)
‚îú‚îÄ‚îÄ queries.rs      # Proxy, routes, history, learned strategies
‚îú‚îÄ‚îÄ routing.rs      # Routing rules CRUD
‚îî‚îÄ‚îÄ types.rs        # Data types, settings keys
```

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- **–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞**: `rusqlite` (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è)
- **Async wrapper**: `tokio::task::spawn_blocking` + `Arc<Mutex<Connection>>`
- **–°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è**: `serde_json` –¥–ª—è complex types
- **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ**: Windows DPAPI –¥–ª—è –ø–∞—Ä–æ–ª–µ–π –ø—Ä–æ–∫—Å–∏

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ API
| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ú–µ—Ç–æ–¥–æ–≤ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|---------|----------|
| Settings | 6 | CRUD –Ω–∞—Å—Ç—Ä–æ–µ–∫, typed settings |
| Strategy Cache | 5 | –ö—ç—à —Å—Ç—Ä–∞—Ç–µ–≥–∏–π —Å TTL |
| Proxy Management | 7 | CRUD –ø—Ä–æ–∫—Å–∏, active state |
| Domain/App Routes | 6 | –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ –¥–æ–º–µ–Ω–∞–º/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º |
| Test History | 2 | –ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Å—Ç–æ–≤ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π |
| Learned Strategies | 5 | Orchestra –æ–±—É—á–µ–Ω–∏–µ |
| Strategy History | 5 | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—Ö–æ–≤/–Ω–µ—É–¥–∞—á |
| Routing Rules | 5 | High-level routing |
| **–ò—Ç–æ–≥–æ** | **41** | –º–µ—Ç–æ–¥–æ–≤ |

### –ü–∞—Ç—Ç–µ—Ä–Ω —Ç–µ–∫—É—â–µ–≥–æ async wrapper
```rust
pub async fn get_setting<T>(&self, key: &str) -> Result<Option<T>> {
    let conn = self.conn.clone();  // Arc<Mutex<Connection>>
    let key = key.to_string();     // Clone –¥–ª—è move

    let result = tokio::task::spawn_blocking(move || {
        let conn = conn.blocking_lock();  // –ë–ª–æ–∫–∏—Ä—É—é—â–∏–π lock
        conn.query_row(...)
    })
    .await
    .map_err(|e| IsolateError::Storage(e.to_string()))??;
    
    // –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
    Ok(serde_json::from_str(&result)?)
}
```

**–ü—Ä–æ–±–ª–µ–º—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:**
1. –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é blocking task
2. `blocking_lock()` –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å Tokio worker
3. –ú–Ω–æ–≥–æ boilerplate –∫–æ–¥–∞ (clone, move, error mapping)
4. –ù–µ—Ç connection pooling
5. –ù–µ—Ç compile-time –ø—Ä–æ–≤–µ—Ä–∫–∏ SQL

---

## 2. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ Async SQLite

### 2.1 tokio-rusqlite

**–û–ø–∏—Å–∞–Ω–∏–µ**: Async wrapper –Ω–∞–¥ rusqlite, –≤—ã–ø–æ–ª–Ω—è–µ—Ç SQL –≤ dedicated thread.

**–ü–ª—é—Å—ã:**
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è API (rusqlite API —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)
- ‚úÖ –ú–∞–ª–µ–Ω—å–∫–∏–π —Ä–∞–∑–º–µ—Ä (~50KB)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ (rusqlite –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º)
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è –º–∏–≥—Ä–∞—Ü–∏—è ‚Äî –∑–∞–º–µ–Ω–∏—Ç—å `spawn_blocking` –Ω–∞ `conn.call()`

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –ù–µ—Ç compile-time –ø—Ä–æ–≤–µ—Ä–∫–∏ SQL
- ‚ùå –ù–µ—Ç connection pool (single connection)
- ‚ùå –í—Å—ë –µ—â—ë —Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

**–ü—Ä–∏–º–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–∏:**
```rust
// –î–æ (—Ç–µ–∫—É—â–∏–π –∫–æ–¥)
let result = tokio::task::spawn_blocking(move || {
    let conn = conn.blocking_lock();
    conn.query_row("SELECT value FROM settings WHERE key = ?1", params![key], |row| row.get(0))
}).await??;

// –ü–æ—Å–ª–µ (tokio-rusqlite)
let result = conn.call(|conn| {
    conn.query_row("SELECT value FROM settings WHERE key = ?1", params![key], |row| row.get(0))
}).await?;
```

**–û—Ü–µ–Ω–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏**: ~2-3 –¥–Ω—è

---

### 2.2 SQLx

**–û–ø–∏—Å–∞–Ω–∏–µ**: Pure Rust async SQL toolkit —Å compile-time –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∑–∞–ø—Ä–æ—Å–æ–≤.

**–ü–ª—é—Å—ã:**
- ‚úÖ Compile-time –ø—Ä–æ–≤–µ—Ä–∫–∞ SQL (–º–∞–∫—Ä–æ—Å `sqlx::query!`)
- ‚úÖ Connection pool –∏–∑ –∫–æ—Ä–æ–±–∫–∏
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π
- ‚úÖ –û—Ç–ª–∏—á–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞, –±–æ–ª—å—à–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –¢—Ä–µ–±—É–µ—Ç DATABASE_URL –ø—Ä–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –¥–ª—è `query!`
- ‚ùå –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ (–Ω–æ–≤—ã–π API)
- ‚ùå –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –±–∏–Ω–∞—Ä–Ω–∏–∫–∞ (~1-2MB)
- ‚ùå –î–æ–ª—å—à–µ –∫–æ–º–ø–∏–ª—è—Ü–∏—è (–ø—Ä–æ–≤–µ—Ä–∫–∞ SQL)

**–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞:**
```rust
// –° compile-time –ø—Ä–æ–≤–µ—Ä–∫–æ–π
let setting = sqlx::query_as!(
    SettingRow,
    "SELECT key, value FROM settings WHERE key = ?",
    key
)
.fetch_optional(&pool)
.await?;

// –ò–ª–∏ runtime –∑–∞–ø—Ä–æ—Å—ã (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏)
let setting = sqlx::query("SELECT key, value FROM settings WHERE key = ?")
    .bind(key)
    .fetch_optional(&pool)
    .await?;
```

**–û—Ü–µ–Ω–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏**: ~5-7 –¥–Ω–µ–π

---

### 2.3 SeaORM

**–û–ø–∏—Å–∞–Ω–∏–µ**: Async ORM –ø–æ–≤–µ—Ä—Ö SQLx —Å entity-based –ø–æ–¥—Ö–æ–¥–æ–º.

**–ü–ª—é—Å—ã:**
- ‚úÖ Type-safe queries —á–µ—Ä–µ–∑ entities
- ‚úÖ –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è entities –∏–∑ —Å—Ö–µ–º—ã
- ‚úÖ –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
- ‚úÖ ActiveRecord –ø–∞—Ç—Ç–µ—Ä–Ω

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå Overhead ORM (–ª–∏—à–Ω—è—è –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è)
- ‚ùå –ë–æ–ª—å—à–æ–π —Ä–∞–∑–º–µ—Ä –±–∏–Ω–∞—Ä–Ω–∏–∫–∞ (+3-5MB)
- ‚ùå –°–ª–æ–∂–Ω–µ–µ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚ùå –¢—Ä–µ–±—É–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ entity —Ñ–∞–π–ª–æ–≤
- ‚ùå –ò–∑–±—ã—Ç–æ—á–µ–Ω –¥–ª—è –Ω–∞—à–µ–≥–æ use case

**–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞:**
```rust
// Entity definition
#[derive(Clone, Debug, DeriveEntityModel)]
#[sea_orm(table_name = "settings")]
pub struct Model {
    #[sea_orm(primary_key)]
    pub key: String,
    pub value: String,
    pub updated_at: String,
}

// Query
let setting = Settings::find_by_id(key)
    .one(&db)
    .await?;
```

**–û—Ü–µ–Ω–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏**: ~7-10 –¥–Ω–µ–π

---

### 2.4 diesel-async

**–û–ø–∏—Å–∞–Ω–∏–µ**: Async –≤–µ—Ä—Å–∏—è Diesel ORM.

**–ü–ª—é—Å—ã:**
- ‚úÖ Compile-time –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ DSL
- ‚úÖ –ú–æ—â–Ω—ã–π query builder

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå **–ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç SQLite** (—Ç–æ–ª—å–∫–æ PostgreSQL, MySQL)
- ‚ùå –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞

**–í–µ—Ä–¥–∏–∫—Ç**: ‚ùå –ò—Å–∫–ª—é—á—ë–Ω

---

## 3. –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞

| –ö—Ä–∏—Ç–µ—Ä–∏–π | tokio-rusqlite | SQLx | SeaORM |
|----------|----------------|------|--------|
| **–°–ª–æ–∂–Ω–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏** | üü¢ –ù–∏–∑–∫–∞—è | üü° –°—Ä–µ–¥–Ω—è—è | üî¥ –í—ã—Å–æ–∫–∞—è |
| **–ò–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ** | ~200 —Å—Ç—Ä–æ–∫ | ~800 —Å—Ç—Ä–æ–∫ | ~1500 —Å—Ç—Ä–æ–∫ |
| **Compile-time SQL** | ‚ùå | ‚úÖ | ‚úÖ (—á–µ—Ä–µ–∑ SQLx) |
| **Connection Pool** | ‚ùå | ‚úÖ | ‚úÖ |
| **–†–∞–∑–º–µ—Ä –±–∏–Ω–∞—Ä–Ω–∏–∫–∞** | +50KB | +1-2MB | +3-5MB |
| **–í—Ä–µ–º—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏** | –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π | +10-15% | +20-30% |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | üü¢ –û—Ç–ª–∏—á–Ω–∞—è | üü¢ –û—Ç–ª–∏—á–Ω–∞—è | üü° –•–æ—Ä–æ—à–∞—è |
| **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å Tokio** | ‚úÖ | ‚úÖ | ‚úÖ |
| **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ Windows** | ‚úÖ | ‚úÖ | ‚úÖ |
| **–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞** | üü° –°—Ä–µ–¥–Ω—è—è | üü¢ –í—ã—Å–æ–∫–∞—è | üü¢ –í—ã—Å–æ–∫–∞—è |
| **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** | üü° –ë–∞–∑–æ–≤–∞—è | üü¢ –û—Ç–ª–∏—á–Ω–∞—è | üü¢ –•–æ—Ä–æ—à–∞—è |

---

## 4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

### üèÜ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: **tokio-rusqlite**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

1. **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫** ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è rusqlite API, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
2. **–ë—ã—Å—Ç—Ä–∞—è –º–∏–≥—Ä–∞—Ü–∏—è** ‚Äî 2-3 –¥–Ω—è –≤–º–µ—Å—Ç–æ –Ω–µ–¥–µ–ª–∏
3. **–ù–µ—Ç overhead** ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Ä–∞–∑–º–µ—Ä –±–∏–Ω–∞—Ä–Ω–∏–∫–∞
4. **–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –∑–∞–¥–∞—á–∏** ‚Äî –Ω–∞–º –Ω–µ –Ω—É–∂–µ–Ω connection pool (single-user desktop app)
5. **–ü—Ä–æ—â–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∞** ‚Äî –º–µ–Ω—å—à–µ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞ = –º–µ–Ω—å—à–µ –±–∞–≥–æ–≤

**–ö–æ–≥–¥–∞ –≤—ã–±—Ä–∞—Ç—å SQLx:**
- –ï—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–∞ PostgreSQL/MySQL
- –ï—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–∞ compile-time –ø—Ä–æ–≤–µ—Ä–∫–∞ SQL
- –ï—Å–ª–∏ –Ω—É–∂–µ–Ω connection pool –¥–ª—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞

**–ö–æ–≥–¥–∞ –≤—ã–±—Ä–∞—Ç—å SeaORM:**
- –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –≤—ã—Ä–∞—Å—Ç–µ—Ç –¥–æ —Å–ª–æ–∂–Ω–æ–π –¥–æ–º–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
- –ï—Å–ª–∏ –Ω—É–∂–Ω—ã —Å–ª–æ–∂–Ω—ã–µ relations –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏
- –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç ORM –ø–æ–¥—Ö–æ–¥

---

## 5. –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ tokio-rusqlite

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (0.5 –¥–Ω—è)
```toml
# Cargo.toml
[dependencies]
tokio-rusqlite = "0.5"
# rusqlite –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ transitive dependency
```

### –≠—Ç–∞–ø 2: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Storage struct (0.5 –¥–Ω—è)
```rust
// –î–æ
pub struct Storage {
    conn: Arc<Mutex<Connection>>,
}

// –ü–æ—Å–ª–µ
pub struct Storage {
    conn: tokio_rusqlite::Connection,
}

impl Storage {
    pub async fn new() -> Result<Self> {
        let db_path = Self::get_db_path()?;
        let conn = tokio_rusqlite::Connection::open(&db_path).await?;
        
        // Init schema
        conn.call(|conn| migrations::init_schema(conn)).await?;
        
        Ok(Self { conn })
    }
}
```

### –≠—Ç–∞–ø 3: –ú–∏–≥—Ä–∞—Ü–∏—è –º–µ—Ç–æ–¥–æ–≤ (1-1.5 –¥–Ω—è)
```rust
// –î–æ
pub async fn get_setting<T>(&self, key: &str) -> Result<Option<T>> {
    let conn = self.conn.clone();
    let key = key.to_string();

    let result: Option<String> = tokio::task::spawn_blocking(move || {
        let conn = conn.blocking_lock();
        conn.query_row(
            "SELECT value FROM settings WHERE key = ?1",
            params![key],
            |row| row.get(0),
        ).optional()
    }).await.map_err(|e| IsolateError::Storage(e.to_string()))??;

    match result {
        Some(json) => Ok(Some(serde_json::from_str(&json)?)),
        None => Ok(None),
    }
}

// –ü–æ—Å–ª–µ
pub async fn get_setting<T>(&self, key: &str) -> Result<Option<T>> {
    let key = key.to_string();

    let result: Option<String> = self.conn.call(move |conn| {
        conn.query_row(
            "SELECT value FROM settings WHERE key = ?1",
            params![key],
            |row| row.get(0),
        ).optional()
    }).await?;

    match result {
        Some(json) => Ok(Some(serde_json::from_str(&json)?)),
        None => Ok(None),
    }
}
```

### –≠—Ç–∞–ø 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (0.5 –¥–Ω—è)
- –ó–∞–ø—É—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö unit —Ç–µ—Å—Ç–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Tauri commands
- –¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –≠—Ç–∞–ø 5: Cleanup (0.5 –¥–Ω—è)
- –£–¥–∞–ª–µ–Ω–∏–µ `Arc<Mutex<>>` wrapper
- –£–ø—Ä–æ—â–µ–Ω–∏–µ error handling
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

---

## 6. –û—Ü–µ–Ω–∫–∞ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç

| –≠—Ç–∞–ø | –í—Ä–µ–º—è | –†–∏—Å–∫ |
|------|-------|------|
| –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ | 0.5 –¥–Ω—è | –ù–∏–∑–∫–∏–π |
| –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ struct | 0.5 –¥–Ω—è | –ù–∏–∑–∫–∏–π |
| –ú–∏–≥—Ä–∞—Ü–∏—è –º–µ—Ç–æ–¥–æ–≤ | 1.5 –¥–Ω—è | –°—Ä–µ–¥–Ω–∏–π |
| –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | 0.5 –¥–Ω—è | –ù–∏–∑–∫–∏–π |
| Cleanup | 0.5 –¥–Ω—è | –ù–∏–∑–∫–∏–π |
| **–ò—Ç–æ–≥–æ** | **3-4 –¥–Ω—è** | **–ù–∏–∑–∫–∏–π** |

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞–º–∏
- **SQLx**: 5-7 –¥–Ω–µ–π, —Å—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫
- **SeaORM**: 7-10 –¥–Ω–µ–π, –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫

---

## 7. –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

| –†–∏—Å–∫ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-------------|-----------|
| Breaking changes –≤ API | –ù–∏–∑–∫–∞—è | tokio-rusqlite —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç rusqlite API |
| –ü—Ä–æ–±–ª–µ–º—ã —Å Windows | –ù–∏–∑–∫–∞—è | rusqlite —Ö–æ—Ä–æ—à–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ Windows |
| Deadlocks | –ù–∏–∑–∫–∞—è | tokio-rusqlite –∏—Å–ø–æ–ª—å–∑—É–µ—Ç dedicated thread |
| –†–µ–≥—Ä–µ—Å—Å–∏–∏ | –°—Ä–µ–¥–Ω—è—è | –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ |

---

## 8. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω: SQLx (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ compile-time –ø—Ä–æ–≤–µ—Ä–∫–∞)

–ï—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è compile-time –ø—Ä–æ–≤–µ—Ä–∫–∞ SQL:

```rust
// Cargo.toml
[dependencies]
sqlx = { version = "0.7", features = ["runtime-tokio", "sqlite"] }

// Storage
pub struct Storage {
    pool: SqlitePool,
}

impl Storage {
    pub async fn new() -> Result<Self> {
        let pool = SqlitePool::connect(&format!("sqlite:{}", db_path)).await?;
        sqlx::migrate!("./migrations").run(&pool).await?;
        Ok(Self { pool })
    }
    
    pub async fn get_setting(&self, key: &str) -> Result<Option<String>> {
        let row = sqlx::query("SELECT value FROM settings WHERE key = ?")
            .bind(key)
            .fetch_optional(&self.pool)
            .await?;
        Ok(row.map(|r| r.get("value")))
    }
}
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**tokio-rusqlite** ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞:
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–Ω–∞–∫–æ–º–æ–≥–æ API
- –ë—ã—Å—Ç—Ä–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –±–µ–∑ —Ä–∏—Å–∫–æ–≤
- –î–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è desktop –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ SQLx –∏–ª–∏ SeaORM –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∞ –≤ –±—É–¥—É—â–µ–º, –µ—Å–ª–∏ –ø–æ—è–≤—è—Ç—Å—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ compile-time –ø—Ä–æ–≤–µ—Ä–∫–µ SQL –∏–ª–∏ connection pooling.

---

## 9. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–≤—å—é (–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä #2)

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏

#### 9.1 –ù–µ–≤–µ—Ä–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ `spawn_blocking`

**–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏:**
> "–ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é blocking task"
> "`blocking_lock()` –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å Tokio worker"

**–†–µ–∞–ª—å–Ω–æ—Å—Ç—å:**
–≠—Ç–æ **–Ω–µ–≤–µ—Ä–Ω–æ**. `tokio::task::spawn_blocking` —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ —Å–æ–∑–¥–∞–Ω –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä—É—é—â–µ–≥–æ –∫–æ–¥–∞. –û–Ω:
1. –í—ã–ø–æ–ª–Ω—è–µ—Ç closure –≤ **–æ—Ç–¥–µ–ª—å–Ω–æ–º thread pool** (–Ω–µ –≤ async worker threads)
2. **–ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç** Tokio async workers
3. Thread pool –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è (–¥–æ 512 threads –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

`blocking_lock()` –≤–Ω—É—Ç—Ä–∏ `spawn_blocking` ‚Äî —ç—Ç–æ **–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω**, —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–π Tokio:
```rust
// –≠—Ç–æ –ü–†–ê–í–ò–õ–¨–ù–û –∏ –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç async runtime
tokio::task::spawn_blocking(move || {
    let conn = conn.blocking_lock();  // OK - –º—ã –≤ blocking thread
    conn.query_row(...)
}).await
```

**–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –±—ã** –µ—Å–ª–∏ –±—ã –º—ã –≤—ã–∑—ã–≤–∞–ª–∏ `blocking_lock()` –Ω–∞–ø—Ä—è–º—É—é –≤ async –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ:
```rust
// –≠–¢–û –±—ã–ª–æ –±—ã –ø—Ä–æ–±–ª–µ–º–æ–π (–Ω–æ –º—ã —Ç–∞–∫ –ù–ï –¥–µ–ª–∞–µ–º)
async fn bad_example() {
    let conn = conn.blocking_lock();  // –ü–õ–û–•–û - –±–ª–æ–∫–∏—Ä—É–µ—Ç async worker
}
```

#### 9.2 Overhead spawn_blocking –ø—Ä–µ—É–≤–µ–ª–∏—á–µ–Ω

**–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:**
> "–ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é blocking task"

**–†–µ–∞–ª—å–Ω–æ—Å—Ç—å:**
- `spawn_blocking` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **thread pool**, –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π thread –∫–∞–∂–¥—ã–π —Ä–∞–∑
- Overhead: ~1-5 –º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥ –Ω–∞ –≤—ã–∑–æ–≤
- –î–ª—è desktop app —Å ~10-50 DB –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —Å–µ–∫—É–Ω–¥—É —ç—Ç–æ **–Ω–µ–∑–∞–º–µ—Ç–Ω–æ**

#### 9.3 Connection Pool –Ω–µ –Ω—É–∂–µ–Ω

**–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:**
> "–ù–µ—Ç connection pooling" (–∫–∞–∫ –º–∏–Ω—É—Å)

**–†–µ–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è Isolate:**
- –≠—Ç–æ **single-user desktop application**
- –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å, –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ UI
- SQLite –≤ —Ä–µ–∂–∏–º–µ WAL –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç concurrent reads
- Connection pool –ø–æ–ª–µ–∑–µ–Ω –¥–ª—è **—Å–µ—Ä–≤–µ—Ä–æ–≤** —Å —Å–æ—Ç–Ω—è–º–∏ concurrent requests
- –î–ª—è desktop app **–æ–¥–∏–Ω connection** ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞ –∏ –¥–∞–∂–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ (–º–µ–Ω—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤)

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω—ã

#### 9.4 `deadpool-sqlite` (Connection Pool)

**–û–ø–∏—Å–∞–Ω–∏–µ:** Async connection pool –¥–ª—è rusqlite, —á–∞—Å—Ç—å —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã deadpool.

```rust
use deadpool_sqlite::{Config, Runtime};

let pool = Config::new("data.db").create_pool(Runtime::Tokio1)?;
let conn = pool.get().await?;
let result = conn.interact(|conn| {
    conn.query_row("SELECT value FROM settings WHERE key = ?1", params![key], |row| row.get(0))
}).await??;
```

**–ü–ª—é—Å—ã:**
- ‚úÖ Connection pooling (–µ—Å–ª–∏ –±—ã –±—ã–ª –Ω—É–∂–µ–Ω)
- ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (v0.12.1, –∏—é–ª—å 2025)
- ‚úÖ –ß–∞—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–π —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã deadpool

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå Pool **–Ω–µ –Ω—É–∂–µ–Ω** –¥–ª—è single-user app
- ‚ùå –î–æ–±–∞–≤–ª—è–µ—Ç complexity –±–µ–∑ benefit
- ‚ùå API –ø–æ—Ö–æ–∂ –Ω–∞ tokio-rusqlite, –Ω–æ —Å –ª–∏—à–Ω–µ–π –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–µ–π

**–í–µ—Ä–¥–∏–∫—Ç:** ‚ùå –ò–∑–±—ã—Ç–æ—á–µ–Ω –¥–ª—è Isolate

#### 9.5 –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π async wrapper —Å channels

**–ò–¥–µ—è:** –°–æ–∑–¥–∞—Ç—å dedicated thread —Å mpsc channel –¥–ª—è SQL –æ–ø–µ—Ä–∞—Ü–∏–π.

```rust
struct SqliteWorker {
    sender: mpsc::Sender<SqlCommand>,
}

impl SqliteWorker {
    async fn query<T>(&self, sql: &str) -> Result<T> {
        let (tx, rx) = oneshot::channel();
        self.sender.send(SqlCommand::Query { sql, response: tx }).await?;
        rx.await?
    }
}
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å
- ‚úÖ –ú–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –ò–∑–æ–±—Ä–µ—Ç–µ–Ω–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ (tokio-rusqlite –¥–µ–ª–∞–µ—Ç —Ç–æ –∂–µ —Å–∞–º–æ–µ)
- ‚ùå –ë–æ–ª—å—à–µ –∫–æ–¥–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- ‚ùå –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –±–∞–≥–∏ –≤ —Å–∞–º–æ–ø–∏—Å–Ω–æ–º –∫–æ–¥–µ

**–í–µ—Ä–¥–∏–∫—Ç:** ‚ùå –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è

#### 9.6 –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å (`spawn_blocking`)

**–≠—Ç–æ —Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –±—ã–ª —Å–µ—Ä—å—ë–∑–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω!**

**–¢–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:**
```rust
pub async fn get_setting<T>(&self, key: &str) -> Result<Option<T>> {
    let conn = self.conn.clone();
    let key = key.to_string();

    let result = tokio::task::spawn_blocking(move || {
        let conn = conn.blocking_lock();
        conn.query_row(...)
    }).await??;
    
    Ok(serde_json::from_str(&result)?)
}
```

**–ü–ª—é—Å—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:**
- ‚úÖ **–£–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç** ‚Äî –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤ production
- ‚úÖ **–ù–µ—Ç –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π** ‚Äî —Ç–æ–ª—å–∫–æ tokio (—É–∂–µ –µ—Å—Ç—å)
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** ‚Äî spawn_blocking –¥–ª—è blocking I/O
- ‚úÖ **–ù—É–ª–µ–≤–æ–π —Ä–∏—Å–∫** ‚Äî –Ω–µ –Ω—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è
- ‚úÖ **–ü–æ–Ω—è—Ç–Ω—ã–π –∫–æ–¥** ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Tokio –ø–∞—Ç—Ç–µ—Ä–Ω

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå Boilerplate (clone, move, error mapping) ‚Äî –Ω–æ —ç—Ç–æ **~5 —Å—Ç—Ä–æ–∫ –Ω–∞ –º–µ—Ç–æ–¥**
- ‚ùå –ù–µ—Ç compile-time SQL –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚Äî –Ω–æ –µ—ë –Ω–µ—Ç –∏ –≤ tokio-rusqlite

### –û—Ü–µ–Ω–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

#### –†–µ–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ—à–µ–Ω–∏—è

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ | –ü—Ä–æ–±–ª–µ–º–∞? |
|---------|----------|-----------|
| –ú–µ—Ç–æ–¥–æ–≤ –≤ Storage | 41 | –ù–µ—Ç |
| –°—Ç—Ä–æ–∫ boilerplate –Ω–∞ –º–µ—Ç–æ–¥ | ~5 | –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ |
| Overhead spawn_blocking | ~1-5 Œºs | –ù–µ–∑–∞–º–µ—Ç–Ω–æ |
| Concurrent DB operations | 1-10/—Å–µ–∫ | –ù–æ—Ä–º–∞ –¥–ª—è desktop |
| Memory overhead | ~0 | –ù–µ—Ç |
| Bugs –∏–∑-–∑–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ | 0 | –ù–µ—Ç |

#### –ß—Ç–æ –¥–∞—Å—Ç –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ tokio-rusqlite?

| –£–ª—É—á—à–µ–Ω–∏–µ | –†–µ–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç |
|-----------|-----------------|
| –ú–µ–Ω—å—à–µ boilerplate | ~200 —Å—Ç—Ä–æ–∫ —ç–∫–æ–Ω–æ–º–∏–∏ (–∏–∑ ~2000) = 10% |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | –ù–µ–∑–∞–º–µ—Ç–Ω–æ (–æ–±–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç dedicated thread) |
| –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å | –û–¥–∏–Ω–∞–∫–æ–≤–æ (–æ–±–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã) |
| –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ | –ù–µ—Ç |

#### ROI –∞–Ω–∞–ª–∏–∑

```
–ó–∞—Ç—Ä–∞—Ç—ã –º–∏–≥—Ä–∞—Ü–∏–∏:
- 3-4 –¥–Ω—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- –†–∏—Å–∫ —Ä–µ–≥—Ä–µ—Å—Å–∏–π
- –ù–æ–≤–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏

–í—ã–≥–æ–¥–∞:
- ~200 —Å—Ç—Ä–æ–∫ –º–µ–Ω—å—à–µ boilerplate
- "–ß–∏—â–µ" –∫–æ–¥ (—Å—É–±—ä–µ–∫—Ç–∏–≤–Ω–æ)

ROI = –í—ã–≥–æ–¥–∞ / –ó–∞—Ç—Ä–∞—Ç—ã = –ù–ò–ó–ö–ò–ô
```

### –§–∏–Ω–∞–ª—å–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

#### üèÜ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: **–ù–ï –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

1. **–¢–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ**
   - `spawn_blocking` + `blocking_lock()` ‚Äî —ç—Ç–æ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–π Tokio –ø–∞—Ç—Ç–µ—Ä–Ω
   - –ù–µ—Ç performance –ø—Ä–æ–±–ª–µ–º
   - –ù–µ—Ç –±–∞–≥–æ–≤ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å async/SQLite

2. **–ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ —Ä–µ—à–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º**
   - "–ü—Ä–æ–±–ª–µ–º—ã" –æ–ø–∏—Å–∞–Ω–Ω—ã–µ –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏ ‚Äî –Ω–µ –ø—Ä–æ–±–ª–µ–º—ã
   - Connection pool –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è desktop app
   - Compile-time SQL –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø–æ—è–≤–∏—Ç—Å—è

3. **–†–∏—Å–∫ > –í—ã–≥–æ–¥–∞**
   - 3-4 –¥–Ω—è —Ä–∞–±–æ—Ç—ã —Ä–∞–¥–∏ ~200 —Å—Ç—Ä–æ–∫
   - –ù–æ–≤–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å = –Ω–æ–≤—ã–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –±–∞–≥–∏
   - –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ –≤ 41 –º–µ—Ç–æ–¥–µ

4. **–õ—É—á—à–µ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏**
   - –ï—Å–ª–∏ —Ö–æ—á–µ—Ç—Å—è —É–ª—É—á—à–∏—Ç—å Storage ‚Äî –¥–æ–±–∞–≤–∏—Ç—å compile-time SQL —á–µ—Ä–µ–∑ SQLx
   - –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ bottlenecks
   - –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ —Ç–µ—Å—Ç–æ–≤

#### –ö–æ–≥–¥–∞ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ—à–µ–Ω–∏–µ?

–ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ tokio-rusqlite –∏–ª–∏ SQLx –∏–º–µ–µ—Ç —Å–º—ã—Å–ª –µ—Å–ª–∏:
- [ ] –ü–æ—è–≤—è—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ performance –ø—Ä–æ–±–ª–µ–º—ã (–ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∂–µ—Ç bottleneck –≤ DB)
- [ ] –ù—É–∂–Ω–∞ compile-time SQL –ø—Ä–æ–≤–µ—Ä–∫–∞ (—Ç–æ–≥–¥–∞ SQLx, –Ω–µ tokio-rusqlite)
- [ ] –ü—Ä–æ–µ–∫—Ç —Å—Ç–∞–Ω–µ—Ç multi-user/server (—Ç–æ–≥–¥–∞ connection pool)
- [ ] –ü–æ—è–≤—è—Ç—Å—è –±–∞–≥–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ç–µ–∫—É—â–∏–º async –ø–æ–¥—Ö–æ–¥–æ–º

#### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å –≤—Ä–µ–º—è)

–í–º–µ—Å—Ç–æ –º–∏–≥—Ä–∞—Ü–∏–∏, –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∫–æ–¥:

1. **–ú–∞–∫—Ä–æ—Å –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è boilerplate:**
```rust
macro_rules! db_query {
    ($self:expr, $query:expr, $params:expr, $map:expr) => {{
        let conn = $self.conn.clone();
        tokio::task::spawn_blocking(move || {
            let conn = conn.blocking_lock();
            $query(&conn, $params, $map)
        }).await.map_err(|e| IsolateError::Storage(e.to_string()))?
    }};
}
```

2. **–í—ã–Ω–µ—Å—Ç–∏ error mapping –≤ helper:**
```rust
async fn spawn_db<F, T>(f: F) -> Result<T>
where
    F: FnOnce() -> Result<T, rusqlite::Error> + Send + 'static,
    T: Send + 'static,
{
    tokio::task::spawn_blocking(f)
        .await
        .map_err(|e| IsolateError::Storage(e.to_string()))?
        .map_err(|e| IsolateError::Storage(e.to_string()))
}
```

–≠—Ç–æ –¥–∞—Å—Ç ~50% —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è boilerplate **–±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ —Ä–∏—Å–∫–æ–≤**.

---

## 10. –ò—Ç–æ–≥–æ–≤–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –¢–µ–∫—É—â–∏–π (spawn_blocking) | tokio-rusqlite | SQLx |
|----------|--------------------------|----------------|------|
| **–†–∞–±–æ—Ç–∞–µ—Ç —Å–µ–π—á–∞—Å** | ‚úÖ –î–∞ | ‚ùå –ù—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è | ‚ùå –ù—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è |
| **–†–∏—Å–∫** | ‚úÖ –ù—É–ª–µ–≤–æ–π | üü° –ù–∏–∑–∫–∏–π | üü° –°—Ä–µ–¥–Ω–∏–π |
| **–í—Ä–µ–º—è** | ‚úÖ 0 –¥–Ω–µ–π | üü° 3-4 –¥–Ω—è | üî¥ 5-7 –¥–Ω–µ–π |
| **Boilerplate** | üü° –°—Ä–µ–¥–Ω–∏–π | ‚úÖ –ù–∏–∑–∫–∏–π | ‚úÖ –ù–∏–∑–∫–∏–π |
| **Compile-time SQL** | ‚ùå –ù–µ—Ç | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ |
| **Performance** | ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ | ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ | ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ |
| **–î–ª—è desktop app** | ‚úÖ –ò–¥–µ–∞–ª—å–Ω–æ | ‚úÖ –•–æ—Ä–æ—à–æ | üü° –ò–∑–±—ã—Ç–æ—á–Ω–æ |

**–í—ã–≤–æ–¥:** –¢–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥ –æ–ø—Ç–∏–º–∞–ª–µ–Ω –¥–ª—è Isolate. –ú–∏–≥—Ä–∞—Ü–∏—è ‚Äî —ç—Ç–æ premature optimization.
