# Backend API Audit Report

**–î–∞—Ç–∞:** 2025-01  
**–í–µ—Ä—Å–∏—è:** 1.0  
**Scope:** `src-tauri/src/commands/` ‚Äî Tauri IPC commands

---

## –û–±–∑–æ—Ä

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –º–æ–¥—É–ª–∏:
- `mod.rs` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å, re-exports
- `strategies.rs` ‚Äî –∫–æ–º–∞–Ω–¥—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
- `services.rs` ‚Äî –∫–æ–º–∞–Ω–¥—ã —Å–µ—Ä–≤–∏—Å–æ–≤
- `testing.rs` ‚Äî –∫–æ–º–∞–Ω–¥—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- `network.rs` ‚Äî —Å–µ—Ç–µ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
- `proxies.rs` ‚Äî –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ–∫—Å–∏
- `validation.rs` ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥:** ~50+  
**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** –•–æ—Ä–æ—à–æ, –Ω–æ –µ—Å—Ç—å –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è

---

## üî¥ –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Rate Limiting –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∫–æ–º–∞–Ω–¥–∞—Ö

**–§–∞–π–ª:** `strategies.rs`, `services.rs`, `proxies.rs`

**–ü—Ä–æ–±–ª–µ–º–∞:** Rate limiting –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ `apply_strategy` –∏ `run_tests`, –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞ –¥—Ä—É–≥–∏—Ö —Ä–µ—Å—É—Ä—Å–æ—ë–º–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö.

**–ö–æ–º–∞–Ω–¥—ã –±–µ–∑ rate limiting:**
- `test_proxy` ‚Äî –∑–∞–ø—É—Å–∫–∞–µ—Ç sing-box, –¥–µ–ª–∞–µ—Ç HTTP –∑–∞–ø—Ä–æ—Å—ã
- `import_subscription` ‚Äî –¥–µ–ª–∞–µ—Ç HTTP –∑–∞–ø—Ä–æ—Å –∫ –≤–Ω–µ—à–Ω–µ–º—É URL
- `check_all_registry_services` ‚Äî –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- `download_config_updates` ‚Äî —Å–∫–∞—á–∏–≤–∞–µ—Ç —Ñ–∞–π–ª—ã

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å rate limiting:
- `test_proxy` ‚Äî 1 —Ä–∞–∑ –≤ 3 —Å–µ–∫—É–Ω–¥—ã
- `import_subscription` ‚Äî 1 —Ä–∞–∑ –≤ 10 —Å–µ–∫—É–Ω–¥
- `check_all_registry_services` ‚Äî 1 —Ä–∞–∑ –≤ 5 —Å–µ–∫—É–Ω–¥
- `download_config_updates` ‚Äî 1 —Ä–∞–∑ –≤ 60 —Å–µ–∫—É–Ω–¥

---

### 2. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è SSRF —É—è–∑–≤–∏–º–æ—Å—Ç—å –≤ import_subscription

**–§–∞–π–ª:** `proxies.rs:280-310`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–º–∞–Ω–¥–∞ `import_subscription` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π URL –∏ –¥–µ–ª–∞–µ—Ç HTTP –∑–∞–ø—Ä–æ—Å –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∞–¥—Ä–µ—Å–∞.

```rust
pub async fn import_subscription(url: String) -> Result<...> {
    validate_url(&url)?;  // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∞—Ç
    let response = client.get(&url).send().await?;  // –ó–∞–ø—Ä–æ—Å –∫ –ª—é–±–æ–º—É URL
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ (localhost, 127.x.x.x, 192.168.x.x, 10.x.x.x).

---

### 3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ register_custom_service

**–§–∞–π–ª:** `services.rs:95-130`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–º–∞–Ω–¥–∞ –Ω–µ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
- `id` ‚Äî –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ –ø—É—Å—Ç–æ—Ç—É –∏ —Ñ–æ—Ä–º–∞—Ç
- `name` ‚Äî –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è
- `endpoints` ‚Äî URL –Ω–µ –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Å–µ—Ö –ø–æ–ª–µ–π.

---

## üü† –í–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 4. Inconsistent Error Handling

**–ü—Ä–æ–±–ª–µ–º–∞:** –†–∞–∑–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—à–∏–±–æ–∫:
- TypedResultExt —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (—Ö–æ—Ä–æ—à–æ)
- map_err –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–º–µ–Ω–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ)
- –ü—Ä–æ—Å—Ç–æ ? (–ø–ª–æ—Ö–æ ‚Äî —Ç–µ—Ä—è–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `TypedResultExt` –≤–µ–∑–¥–µ.

---

### 5. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∫—Å–∏

**–§–∞–π–ª—ã:** `testing.rs`, `proxies.rs`

**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–æ–≥–∏–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∫—Å–∏ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è:
- `testing.rs:test_proxy_for_service()` ‚Äî ~50 —Å—Ç—Ä–æ–∫
- `proxies.rs:test_proxy()` ‚Äî ~80 —Å—Ç—Ä–æ–∫ –ø–æ—Ö–æ–∂–µ–≥–æ –∫–æ–¥–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í—ã–Ω–µ—Å—Ç–∏ –æ–±—â—É—é –ª–æ–≥–∏–∫—É –≤ `core/proxy_tester.rs`.

---

### 6. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–æ–º–∞–Ω–¥–∞—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–Ω–æ–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã –Ω–µ –∏–º–µ—é—Ç doc comments:
- `get_services_by_category`
- `check_single_service`
- `clear_service_cache`
- –∏ –¥—Ä—É–≥–∏–µ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å doc comments –∫–æ –≤—Å–µ–º –ø—É–±–ª–∏—á–Ω—ã–º –∫–æ–º–∞–Ω–¥–∞–º.

---

### 7. Magic Numbers –≤ –∫–æ–¥–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:
- `timeout_secs = 3` / `5` ‚Äî –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
- `sleep(2 secs)` ‚Äî –ø–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ 2?
- `port 1080`, `10800` ‚Äî –ø–æ—á–µ–º—É —ç—Ç–∏ –ø–æ—Ä—Ç—ã?

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í—ã–Ω–µ—Å—Ç–∏ –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π.

---

### 8. –ù–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π naming –¥–ª—è –∫–æ–º–∞–Ω–¥ —Å–µ—Ä–≤–∏—Å–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–º–µ—à–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∏ –Ω–æ–≤–æ–≥–æ API:
- `get_services` ‚Äî —Å—Ç–∞—Ä—ã–π API
- `get_registry_services` ‚Äî –Ω–æ–≤—ã–π API
- `NewServiceStatus` ‚Äî —Å—Ç—Ä–∞–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å naming, deprecate —Å—Ç–∞—Ä—ã–π API.

---

## üü° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 9. –î–æ–±–∞–≤–∏—Ç—å batch-–æ–ø–µ—Ä–∞—Ü–∏–∏

```rust
pub async fn delete_proxies_batch(ids: Vec<String>) -> Result<BatchResult>;
pub async fn test_proxies_batch(ids: Vec<String>) -> Result<Vec<ProxyTestResult>>;
```

---

### 10. –î–æ–±–∞–≤–∏—Ç—å pagination –¥–ª—è —Å–ø–∏—Å–∫–æ–≤

```rust
pub async fn get_proxies_paginated(
    page: Option<usize>,
    per_page: Option<usize>,
) -> Result<PaginatedResult<ProxyConfig>>;
```

---

### 11. –£–ª—É—á—à–∏—Ç—å —Ç–∏–ø–∏–∑–∞—Ü–∏—é mode –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç—Ä–æ–∫–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–º–µ—Å—Ç–æ enum.

```rust
// –¢–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥
pub async fn set_engine_mode(mode: String)

// –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
pub async fn set_engine_mode(mode: EngineMode)  // enum —Å serde
```

---

### 12. –î–æ–±–∞–≤–∏—Ç—å health check endpoint

```rust
pub struct HealthStatus {
    pub backend_ready: bool,
    pub storage_ok: bool,
    pub strategy_engine_ok: bool,
    pub binaries_verified: bool,
    pub uptime_secs: u64,
}

pub async fn health_check() -> Result<HealthStatus>;
```

---

## üü¢ –ò–¥–µ–∏ –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

### 13. WebSocket events –¥–ª—è real-time updates

–†–∞—Å—à–∏—Ä–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –Ω–∞:
- `strategy:status_changed`
- `proxy:connection_status`
- `service:availability_changed`
- `config:updated`

---

### 14. Command history / audit log

–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ IPC –≤—ã–∑–æ–≤—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.

---

### 15. Dry-run mode –¥–ª—è –æ–ø–∞—Å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

```rust
pub async fn apply_strategy_dry_run(strategy_id: String) -> Result<DryRunResult>;
```

---

### 16. Export/Import –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```rust
pub async fn export_config(include_proxies: bool, ...) -> Result<String>;
pub async fn import_config(config_json: String, merge_mode: MergeMode) -> Result<ImportResult>;
```

---

## –ú–∞—Ç—Ä–∏—Ü–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

| –ö–æ–º–∞–Ω–¥–∞ | Input Validation | Rate Limit | Error Context |
|---------|-----------------|------------|---------------|
| `apply_strategy` | –ù–µ—Ç | –î–∞ | –î–∞ |
| `stop_strategy` | N/A | –ù–µ—Ç | –î–∞ |
| `add_proxy` | –î–∞ | –ù–µ—Ç | –î–∞ |
| `test_proxy` | –ù–µ—Ç | –ù–µ—Ç | –î–∞ |
| `import_subscription` | –ß–∞—Å—Ç–∏—á–Ω–æ | –ù–µ—Ç | –î–∞ |
| `register_custom_service` | –ù–µ—Ç | –ù–µ—Ç | –î–∞ |
| `run_tests` | –ù–µ—Ç | –î–∞ | –î–∞ |
| `set_system_proxy` | –ù–µ—Ç | –ù–µ—Ç | –î–∞ |

---

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. **P0 (–ö—Ä–∏—Ç–∏—á–Ω–æ):** SSRF –≤ `import_subscription`, rate limiting –Ω–∞ `test_proxy`
2. **P1 (–í—ã—Å–æ–∫–∏–π):** –í–∞–ª–∏–¥–∞—Ü–∏—è –≤ `register_custom_service`, —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è error handling
3. **P2 (–°—Ä–µ–¥–Ω–∏–π):** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤–º–µ—Å—Ç–æ magic numbers
4. **P3 (–ù–∏–∑–∫–∏–π):** Batch –æ–ø–µ—Ä–∞—Ü–∏–∏, pagination, dry-run mode

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

API —Å–ª–æ–π —Ö–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–ª–µ–¥—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º Tauri. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. –ù–µ–ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ rate limiting –Ω–∞ —Ä–µ—Å—É—Ä—Å–æ—ë–º–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
3. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è SSRF —É—è–∑–≤–∏–º–æ—Å—Ç—å

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –∑–∞–∫—Ä—ã—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
